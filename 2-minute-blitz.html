<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2-Minute Blitz • Gamify Life</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/blitz.css">
</head>
<body class="blitz">
  <a href="/index.html" class="btn btn--home">Home</a>

  <div class="container">
    <div class="blitz__container">
      <h1 class="blitz__title">2-MINUTE BLITZ</h1>
      <p class="blitz__subtitle">
        Anytime you have a task that takes less than 2 minutes to complete and you do it immediately then you can get this reward.
      </p>
      <p class="blitz__xp"><strong>XP:</strong> +5 per task | <strong>Daily Limit:</strong> Unlimited</p>

      <table class="blitz__table" id="blitzTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Done</th>
            <th>Task</th>
            <th>Category</th>
            <th>Sub-Category</th>
            <th>XP</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="blitz__add-row">
        <input type="text" id="newTask" class="blitz__input" placeholder="What 2-minute task did you just crush?" autocomplete="off">
        <button class="btn blitz__add-btn" onclick="addBlitz()">+ Add Blitz</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script>
    try {
      // Your real Firebase config (already updated!)
      const firebaseConfig = {
        apiKey: "AIzaSyD_XLcVP2KSynm19akbXJOmt-bAMqOJ_2U",
        authDomain: "gamify-life-2025.firebaseapp.com",
        projectId: "gamify-life-2025",
        storageBucket: "gamify-life-2025.firebasestorage.app",
        messagingSenderId: "67156140086",
        appId: "1:67156140086:web:1a2d8593998bbaa463b897",
        measurementId: "G-L9KEJTSDJ1"
      };

      firebase.initializeApp(firebaseConfig);

      let currentUser = null;
      const API_URL = "https://gamify-life-psi.vercel.app";

      firebase.auth().onAuthStateChanged((user) => {
        console.log("Auth state changed:", user ? "Logged in" : "Not logged in"); // Debug log
        currentUser = user;
        if (user) {
          document.body.classList.add("logged-in");
          const loginBox = document.getElementById("login-box");
          if (loginBox) loginBox.remove();
          loadData();
        } else {
          document.body.classList.remove("logged-in");
          showLogin();
        }
      });

      function showLogin() {
        if (document.getElementById("login-box")) return;
        const box = document.createElement("div");
        box.id = "login-box";
        box.style = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:3rem;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.4);z-index:9999;text-align:center;font-family:inherit;width:90%;max-width:400px;";
        box.innerHTML = `
          <h2>Welcome to Gamify Life</h2>
          <p>Sign in to save your data across devices</p>
          <input id="email" placeholder="Email" style="width:100%;padding:1rem;margin:0.5rem 0;font-size:1.1rem;border-radius:12px;border:1px solid #ccc;box-sizing:border-box;"><br>
          <input id="password" type="password" placeholder="Password" style="width:100%;padding:1rem;margin:0.5rem 0;font-size:1.1rem;border-radius:12px;border:1px solid #ccc;box-sizing:border-box;"><br>
          <button onclick="login()" style="margin:0.5rem;padding:1rem 2rem;background:#155e3b;color:white;border:none;border-radius:12px;cursor:pointer;width:100%;">Log In</button>
          <button onclick="signup()" style="margin:0.5rem;padding:1rem 2rem;background:#2d6a4f;color:white;border:none;border-radius:12px;cursor:pointer;width:100%;">Sign Up</button>
          <button onclick="googleLogin()" style="margin:0.5rem;padding:1rem 2rem;background:#4285f4;color:white;border:none;border-radius:12px;cursor:pointer;width:100%;">Google</button>
          <p><small>or <a href="#" onclick="document.getElementById('login-box')?.remove();return false;">continue as guest</a> (no save)</small></p>
        `;
        document.body.appendChild(box);
      }

      window.login = () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        firebase.auth().signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
      };
      window.signup = () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        firebase.auth().createUserWithEmailAndPassword(email, password).catch(e => alert(e.message));
      };
      window.googleLogin = () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).catch(e => alert(e.message));
      };

      // === BLITZ PAGE LOGIC ===
      const table = document.getElementById("blitzTable").querySelector("tbody");
      const today = new Date().toLocaleDateString();
      let goals = [];

      async function loadData() {
        try {
          const headers = {
            "X-User-ID": currentUser ? currentUser.uid : "guest"
          };
          const [goalsRes, blitzRes] = await Promise.all([
            fetch(`${API_URL}/api/goals`, { headers }),
            fetch(`${API_URL}/api/blitz`, { headers })
          ]);
          goals = await goalsRes.json();
          const tasks = await blitzRes.json();
          table.innerHTML = "";
          tasks.forEach(t => addRow(t));
          console.log("Data loaded successfully"); // Debug log
        } catch (e) {
          console.error("Load error:", e);
        }
      }

      async function saveBlitz() {
        const tasks = Array.from(table.rows).map(r => ({
          task: r.cells[2].textContent.trim(),
          completed: r.cells[1].querySelector("input").checked,
          date: r.cells[0].textContent,
          category: r.cells[3].querySelector("select").value,
          subcategory: r.cells[4].querySelector("select").value
        }));
        const headers = {
          "Content-Type": "application/json",
          "X-User-ID": currentUser ? currentUser.uid : "guest"
        };
        await fetch(`${API_URL}/api/blitz`, {
          method: "POST",
          headers,
          body: JSON.stringify(tasks)
        });
      }

      function addBlitz() {
        const input = document.getElementById("newTask");
        const task = input.value.trim();
        if (!task) return;
        addRow({ task, completed: true, date: today, category: "", subcategory: "" });
        input.value = "";
        input.focus();
        saveBlitz();
      }

      function addRow(t) {
        const row = table.insertRow();
        const catOptions = goals.map(z => `<option value="${z.name}" ${z.name === t.category ? "selected" : ""}>${z.name}</option>`).join("");
        const allSubs = goals.flatMap(z => z.subs.map(s => s.name));
        const subOptions = allSubs.map(s => `<option ${s === t.subcategory ? "selected" : ""}>${s}</option>`).join("");

        row.innerHTML = `
          <td>${t.date}</td>
          <td><input type="checkbox" ${t.completed ? "checked" : ""} onchange="toggle(this)"></td>
          <td contenteditable="true" onblur="saveBlitz()">${t.task}</td>
          <td><select onchange="saveBlitz()" class="blitz__select"><option value="">—</option>${catOptions}</select></td>
          <td><select onchange="saveBlitz()" class="blitz__select"><option value="">—</option>${subOptions}</select></td>
          <td class="xp-cell">${t.completed ? "5" : "0"}</td>
          <td><button class="blitz__delete-btn" onclick="this.closest('tr').remove();saveBlitz()">Delete</button></td>
        `;
        if (t.completed) row.classList.add("completed");
      }

      function toggle(cb) {
        const row = cb.closest("tr");
        row.querySelector(".xp-cell").textContent = cb.checked ? "5" : "0";
        row.classList.toggle("completed", cb.checked);
        saveBlitz();
      }

      document.getElementById("newTask").addEventListener("keypress", e => {
        if (e.key === "Enter") addBlitz();
      });
    } catch (e) {
      console.error("Firebase init error:", e);
    }
  </script>
</body>
</html>