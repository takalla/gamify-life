<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2-Minute Blitz â€¢ Gamify Life</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/blitz.css">
</head>
<body class="blitz">
  <a href="/index.html" class="btn btn--home">Home</a>

  <div class="container">
    <div class="blitz__container">
      <h1 class="blitz__title">2-MINUTE BLITZ</h1>
      <p class="blitz__subtitle">
        Anytime you have a task that takes less than 2 minutes to complete and you do it immediately then you can get this reward.
      </p>
      <p class="blitz__xp"><strong>XP:</strong> +5 per task | <strong>Daily Limit:</strong> Unlimited</p>

      <table class="blitz__table" id="blitzTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Done</th>
            <th>Task</th>
            <th>Category</th>
            <th>Sub-Category</th>
            <th>XP</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="blitz__add-row">
        <input type="text" id="newTask" class="blitz__input" placeholder="What 2-minute task did you just crush?" autocomplete="off">
        <button class="btn blitz__add-btn" onclick="addBlitz()">+ Add Blitz</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://gamify-life-psi.vercel.app";
    const table = document.getElementById("blitzTable").querySelector("tbody");
    const today = new Date().toLocaleDateString();

    async function loadBlitz() {
      try {
        const res = await fetch(`${API_URL}/api/blitz`);
        const tasks = await res.json();
        table.innerHTML = "";
        tasks.forEach(t => addRow(t));
      } catch (e) { console.error(e); }
    }

    async function saveBlitz() {
      const tasks = Array.from(table.rows).map(r => ({
        task: r.cells[2].textContent.trim(),
        completed: r.cells[1].querySelector("input").checked,
        date: r.cells[0].textContent,
        category: r.cells[3].querySelector("select").value,
        subcategory: r.cells[4].querySelector("select").value
      }));
      await fetch(`${API_URL}/api/blitz`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(tasks)
      });
    }

    function addBlitz() {
      const input = document.getElementById("newTask");
      const task = input.value.trim();
      if (!task) return;
      addRow({ task, completed: true, date: today, category: "", subcategory: "" });
      input.value = "";
      input.focus();
      saveBlitz();
    }

    async function addRow(t) {
      const row = table.insertRow();
      const zones = await (await fetch(`${API_URL}/api/goals`)).json();

      const catOptions = zones.map(z => `<option value="${z.name}">${z.name}</option>`).join("");
      const allSubs = zones.flatMap(z => z.subs.map(s => s.name));
      const subOptions = allSubs.map(s => `<option>${s}</option>`).join("");

      row.innerHTML = `
        <td>${t.date}</td>
        <td><input type="checkbox" ${t.completed?"checked":""} onchange="toggle(this)"></td>
        <td contenteditable="true" onblur="saveBlitz()">${t.task}</td>
        <td><select onchange="saveBlitz()" style="width:100%;padding:8px;font-size:1rem;"> <option>${t.category||""}</option>${catOptions}</select></td>
        <td><select onchange="saveBlitz()" style="width:100%;padding:8px;font-size:1rem;"> <option>${t.subcategory||""}</option>${subOptions}</select></td>
        <td class="xp-cell">${t.completed?"5":"0"}</td>
        <td><button onclick="this.closest('tr').remove();saveBlitz()" style="background:#aaa;padding:6px 10px;">Delete</button></td>
      `;
      if (t.completed) row.classList.add("completed");
    }

    function toggle(cb) {
      const row = cb.closest("tr");
      const xp = row.querySelector(".xp-cell");
      xp.textContent = cb.checked ? "5" : "0";
      row.classList.toggle("completed", cb.checked);
      saveBlitz();
    }

    loadBlitz();
    document.getElementById("newTask").addEventListener("keypress", e => e.key==="Enter" && addBlitz());
  </script>
</body>
</html>